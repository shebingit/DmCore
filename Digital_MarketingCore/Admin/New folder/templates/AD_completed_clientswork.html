{% extends 'AD_base.html' %}
{% load static %}
{% block body %}

<div>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a class="text-underline-remove" href="{% url 'admin_all_works' %}">Works</a></li>
      <li class="breadcrumb-item"><a class="text-underline-remove" href="{% url 'admin_clientswork_page' %}">Clients</a></li>
      <li class="breadcrumb-item active text-md" aria-current="page">Completed Clients</li>
    </ol>
  </nav>
</div>

<!-- choose employee section -->
<div class="row">
    <div class="col-md-10 grid-margin">
      <div class="card">
        <div class="card-body">
  
          <div class="d-flex">
            <h4 class="card-title mt-3 mb-3">Clients<sup><span class="badge text-success">Completed*</span></sup></h4>
          </div>
  
          <div class="row mb-5 mt-3">
            <div class="col-md-4">
              <form action="" method="post">
                {% csrf_token %}
                <select name="clientselect" id="client-select" class="form-control text-white" onchange="clearDateInputs()">
                  <option value="" hidden>Select</option>
                  {% for i in completed_clients %}
                  <option value="{{i.id}}">{{i.client_name}}</option>
                  {% endfor %}
                </select>
              </form>
            </div>
            <div class="col-md-4"></div>
            <div class="col-md-4"></div>
          </div>
  
        </div>
      </div>
    </div>
</div>

<!-- Works section -->
<div class="row" id="works" style="display: none;">

  <div class="col-md-12 col-xl-12 grid-margin ">
    <div class="row">

      <div class="col-md-2 grid-margin"> 
        <div class="card  h-100" id="rworks-btn">
          <div class="card-body">
          <div class="row">
            <div class="col-12">
            <div class="d-flex align-items-center align-self-start">
                <h4 class="mb-0">Registered Works</h4>
                <p class="text-success ml-2 mb-0 font-weight-medium"></p>
            </div>
            </div>
            <div class="col-1">
            <div class="icon">
            </div>
            </div>
          </div>
          </div>
        </div>
      </div>

      <div class="col-md-2 grid-margin">
        <div class="card  h-100" id="ctasks-btn">
          <div class="card-body">
          <div class="row">
            <div class="col-12">
            <div class="d-flex align-items-center align-self-start">
              <h4 class="mb-0">Client Tasks</h4>
              <p class="text-success ml-2 mb-0 font-weight-medium"></p>
            </div>
            </div>
            <div class="col-3">
            <div class="icon">
            </div>
            </div>
          </div>
          </div>
        </div>
      </div>
      

      <div class="col-md-2 grid-margin">
        <div class="card  h-100" id="assignworks-btn">
          <div class="card-body">
          <div class="row">
            <div class="col-12">
            <div class="d-flex align-items-center align-self-start">
                <h4 class="mb-0">Assigned Tasks</h4>
                <p class="text-success ml-2 mb-0 font-weight-medium"></p>
            </div>
            </div>
            <div class="col-3">
            <div class="icon">
            </div>
            </div>
          </div>
          </div>
        </div>
      </div>

      <div class="col-md-2 grid-margin">
        <div class="card  h-100" id="ongoing-btn">
          <div class="card-body">
          <div class="row">
            <div class="col-12">
            <div class="d-flex align-items-center align-self-start">
                <h4 class="mb-0">Ongoing Tasks</h4>
                <p class="text-success ml-2 mb-0 font-weight-medium"></p>
            </div>
            </div>
            <div class="col-3">
            <div class="icon">
            </div>
            </div>
          </div>
          </div>
        </div>
      </div>

      <div class="col-md-2 grid-margin">
        <div class="card  h-100" id="completed-btn">
          <div class="card-body">
          <div class="row">
            <div class="col-12">
            <div class="d-flex align-items-center align-self-start">
              <h4 class="mb-0">Completed Tasks</h4>
              <p class="text-success ml-2 mb-0 font-weight-medium"></p>
            </div>
            </div>
            <div class="col-3">
            <div class="icon">
            </div>
            </div>
          </div>
          </div>
        </div>
      </div>
      
     
      
      
    </div>
  </div>

  <div class="col-md-12 col-xl-12 grid-margin">

    <div class="card" id="rworks" style="display: none;">
      <div class="card-body">
        <div class="leave-form">
          <h4 class="card-title mb-4">Registered Works</h4>
          
          <div class="table-responsive">
            <div class="row mt-3 mb-3">

              <div class=" col-md-5">
                <div class="form-group">
                  <label>From date</label>
                  <input type="date" class="form-control text-offwhite" name="#" id="fdate1" required >                    
                </div>
              </div>
              <div class=" col-md-5">
                <div class="form-group">
                  <label>To date</label>
                  <input type="date" class="form-control text-offwhite" name="#" id="edate1" required  >                    
                </div>
              </div>
              <div class="col-md-2"></div>
              
                        
            </div>
            <table class="table" id="rwtable">
              <thead>
                <tr>
                  <th>No</th>
                  <th>Created date</th>
                  <th>End Date</th>
                  <th>Assigned Team Leads</th>
                  <th>progress</th>
                  <th>Work Status</th>
                </tr>
              </thead>
              <tbody>
                {% for i in works %}
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                {% endfor %}
                  
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    


    <div class="card" id="ctasks" style="display: none;">
      <div class="card-body">
        <h4 class="card-title mb-4">Client Tasks</h4>
        <div class="table-responsive">
          <div class="row mt-3 mb-3">

            <div class=" col-md-5">
              <div class="form-group">
                <label>From date</label>
                <input type="date" class="form-control text-offwhite" name="#" id="fdate2" required >                    
              </div>
            </div>
            <div class=" col-md-5">
              <div class="form-group">
                <label>To date</label>
                <input type="date" class="form-control text-offwhite" name="#" id="edate2" required  >                    
              </div>
            </div>
            <div class="col-md-2"></div>
            
                      
          </div>
          <table class="table" id="cttable">
          <thead>
            <tr>
              <th>No</th>
              <th>Registered Date</th>
              <th>Task Name</th>
              <th>Description</th>
              <th>Progress</th>
              <!-- <th>Allocation Status</th> -->
              <th>Work Status</th>
            </tr>
          </thead>
          <tbody>
            {% for i in view_complaints %}
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <!-- <td></td> -->
              <td></td>
            </tr>
            {% endfor %}
              
          </tbody>
          </table>
        </div>
      </div>
    </div>


    <div class="card" id="assignworks" style="display: none;">
      <div class="card-body">
        <div class="leave-form">
          <h4 class="card-title mb-4">Assigned Tasks</h4>
          
          <div class="table-responsive">
            <div class="row mt-3 mb-3">

              <div class=" col-md-5">
                <div class="form-group">
                  <label>From date</label>
                  <input type="date" class="form-control text-offwhite" name="#" id="fdate3" required >                    
                </div>
              </div>
              <div class=" col-md-5">
                <div class="form-group">
                  <label>To date</label>
                  <input type="date" class="form-control text-offwhite" name="#" id="edate3" required  >                    
                </div>
              </div>
              <div class="col-md-2"></div>
              
                        
            </div>
            <table class="table" id="watable">
              <thead>
                <tr>
                  <th>No</th>
                  <th>Assigned date</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                  <th>Executives Assigned</th>
                  <th>Tasks</th>
                  <th>Target</th>
                  <th>Acheived Target</th>
                  <th>progress</th>
                </tr>
              </thead>
              <tbody>
                {% for i in works %}
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                {% endfor %}
                  
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="ongoingwork" style="display: none;" >
      <div class="card-body">
        <div class="leave-form">
          <h4 class="card-title mb-4">Ongoing Tasks</h4>
          
          <div class="table-responsive">
            <div class="row mt-3 mb-3">

              <div class=" col-md-5">
                <div class="form-group">
                  <label>From date</label>
                  <input type="date" class="form-control text-offwhite" name="#" id="fdate4" required >                    
                </div>
              </div>
              <div class=" col-md-5">
                <div class="form-group">
                  <label>To date</label>
                  <input type="date" class="form-control text-offwhite" name="#" id="edate4" required  >                    
                </div>
              </div>
              <div class="col-md-2"></div>
              
                        
            </div>
            <table class="table" id="otable">
              <thead>
                <tr>
                  <th>No</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                  <th>Task Name</th>
                  <th>Employee Name</th>
                  <th>Progress</th>
                  <th>Daily Works</th>
                  <th>status</th>
                </tr>
              </thead>
              <tbody>
                {% for i in works %}
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                {% endfor %}
                  
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>


    <div class="card" id="completedwork" style="display: none;">
      <div class="card-body">
        <h4 class="card-title mb-4">Completed Tasks</h4>
        <div class="table-responsive">
          <div class="row mt-3 mb-3">

            <div class=" col-md-5">
              <div class="form-group">
                <label>From date</label>
                <input type="date" class="form-control text-offwhite" name="#" id="fdate5" required >                    
              </div>
            </div>
            <div class=" col-md-5">
              <div class="form-group">
                <label>To date</label>
                <input type="date" class="form-control text-offwhite" name="#" id="edate5" required  >                    
              </div>
            </div>
            <div class="col-md-2"></div>
            
                      
          </div>
          <table class="table" id="ctable">
          <thead>
            <tr>
              <th>No</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Task Name</th>
              <th>Employee Name</th>
              <th>Progress</th>
              <th>Daily Works</th>
              <th>status</th>
            </tr>
          </thead>
          <tbody>
            {% for i in view_complaints %}
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            {% endfor %}
              
          </tbody>
          </table>
        </div>
      </div>
    </div>



    

      
  </div>
  
</div>
   
<!-- Modal for daily works-->

<div class="modal fade" id="dworks">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
  
        <div class="card">
          <div class="card-head d-flex justify-content-between align-items-center mt-3 mb-0 ">
            <h4 class="card-title mt-3 ml-3">Daily Works</h4>
            
          </div>
          
          <div class="card-body mt-0">

            <div class="table-responsive">
                <table class="table" id="dtable">
                    <thead>
                        <tr>
                          <th>No</th>
                          <th>Date</th>
                          <th>Title</th>
                          <th>Description</th>
                          <th>Acheived Target</th>
                          <th>Verified Target</th>
                          <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                       
                        <tr>
                          <td></td>
                          <td></td>
                          <td></td>
                          <td></td>
                          <td></td>
                          <td></td>
                          <td></td>
                            
                        </tr>
                       
                        
                    </tbody>
                </table>
            </div>

  
           
  
          </div>
  
        </div>
      
      </div>
    </div>
</div>

  

<style>
  a{
      text-decoration: none;
  }
  a:hover{
      text-decoration: none;
  }
</style>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Add this script block to your HTML file -->
<script>
  $(document).ready(function () {
    $('#client-select').change(function () {
      var selectedClient = $(this).val();

      if (selectedClient) {
        // Show the tables
        $('#works').show();

        $.ajax({
          type: 'POST',
          url: '{% url "admin_get_client_completedworkdetails" %}',
          data: {
            'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
            'client_id': selectedClient
          },
          success: function (data) {
            // Clear the table bodies
            $('#rwtable tbody').empty();
            $('#cttable tbody').empty();
            $('#watable tbody').empty();
            $('#otable tbody').empty();
            $('#ctable tbody').empty();
            $('#dtable tbody').empty();


            // Populate the table with the registered work data
            for (var i = 0; i < data.details1.length; i++) {
              var emp = data.details1[i];
             
              var progress = `
                <div class="progress">
                  <div class="progress-bar bg-primary progress-bar-animated progress-bar-striped" role="progressbar" style="width: ${emp.progress}%" aria-valuenow="${emp.progress}" aria-valuemin="0" aria-valuemax="100">
                    ${emp.progress}%
                  </div>
                </div>
              `;
              var statusText1 = '';
              if (emp.astatus === 1) {
                statusText1 = '<p class="badge badge-outline-success  mb-2">Assigned</p>';
              } else {
                statusText1 = '<p class="badge badge-outline-warning mb-2">Not assigned</p>';
              }

              var tlNames = emp.tl_names.join(', '); // Join names with a comma and space

              var statusText2 = '';
              if (emp.wstatus === 1) {
                statusText2 = '<p class="badge badge-outline-success  mb-2">Completed</p>';
              } else {
                statusText2 = '<p class="badge badge-outline-warning mb-2">Ongoing</p>';
              }

              var newRow = `
                <tr>
                  <td>${i + 1}</td>
                  <td>${emp.cdate}</td>
                  <td>${emp.edate}</td>
                  <td>${tlNames}</td>
                  <td>${progress}</td>
                 
                  <td>${statusText2}</td>
                  
                </tr>
              `;
              $('#rwtable tbody').append(newRow);
            }

            // Populate the table with the client task data
            for (var i = 0; i < data.details2.length; i++) {
              var emp = data.details2[i];
              var statusText1 = '';
              if (emp.status === 1) {
                statusText1 = '<p class="badge badge-outline-success  mb-2">Allocated</p>';
              } else {
                statusText1 = '<p class="badge badge-outline-warning mb-2">Pending</p>';
              }
              var statusText2 = '';
              if (emp.status === 1) {
                statusText2 = '<p class="badge badge-outline-success  mb-2">Completed</p>';
              } else {
                statusText2 = '<p class="badge badge-outline-warning mb-2">Ongoing</p>';
              }
              var progress = `
                <div class="progress">
                  <div class="progress-bar bg-primary progress-bar-animated progress-bar-striped" role="progressbar" style="width: ${emp.progress}%" aria-valuenow="${emp.progress}" aria-valuemin="0" aria-valuemax="100">
                    ${emp.progress}%
                  </div>
                </div>
              `;


              var newRow = `
                <tr>
                  <td>${i + 1}</td>
                  <td>${emp.date}</td>
                  <td>${emp.task}</td>
                  <td>${emp.description}</td>
                  <td>${progress}</td>
                 
                  <td>${statusText2}</td>
                </tr>
              `;
              $('#cttable tbody').append(newRow);
            }


            // Populate the table with the assign data
            for (var i = 0; i < data.details3.length; i++) {
              var emp = data.details3[i];
              var executiveNames = emp.name.join(', '); // Join names with a comma and space
              var taskNames = emp.task.join(', '); // Join names with a comma and space
              var progress = `
                <div class="progress">
                  <div class="progress-bar bg-primary progress-bar-animated progress-bar-striped" role="progressbar" style="width: ${emp.progress}%" aria-valuenow="${emp.progress}" aria-valuemin="0" aria-valuemax="100">
                    ${emp.progress}%
                  </div>
                </div>
              `;

              var newRow = `
                <tr>
                  <td>${i + 1}</td>
                  <td>${emp.adate}</td>
                  <td>${emp.sdate}</td>
                  <td>${emp.edate}</td>
                  <td>${executiveNames}</td>
                  <td>${taskNames}</td>
                  <td>${emp.target}</td>
                  <td>${emp.atarget}</td>
                  <td>${progress}</td>
                  
                </tr>
              `;
              $('#watable tbody').append(newRow);
            }


            // Populate the table with the ongoing data
            for (var i = 0; i < data.details4.length; i++) {
              var emp = data.details4[i];
              var statusText = '';
              if (emp.status === 1) {
                statusText = '<p class="badge badge-outline-warning  mb-2">Ongoing</p>';
              } else {
                statusText = '<p class="badge badge-outline-danger mb-2">Completed</p>';
              }
              var progress = `
                <div class="progress">
                  <div class="progress-bar bg-primary progress-bar-animated progress-bar-striped" role="progressbar" style="width: ${emp.progress}%" aria-valuenow="${emp.progress}" aria-valuemin="0" aria-valuemax="100">
                    ${emp.progress}%
                  </div>
                </div>
              `;

              var daily_work = `
                <button class="btn btn-outline-info btn-sm rounded daily-work-btn" data-toggle="modal" data-target="#dworks" data-task-id="${emp.id}">Daily Works</button>
              `;

              var newRow = `
                <tr>
                  <td>${i + 1}</td>
                  <td>${emp.sdate}</td>
                  <td>${emp.edate}</td>
                  <td>${emp.name}</td>
                  <td>${emp.employee}</td>
                  <td>${progress}</td>
                  <td>${daily_work}</td>
                  <td>${statusText}</td>
                </tr>
              `;
              $('#otable tbody').append(newRow);
            }

            // Populate the table with the complete data
            for (var i = 0; i < data.details5.length; i++) {
              var emp = data.details5[i];
              var statusText = '';
              if (emp.status === 2) {
                statusText = '<p class="badge badge-outline-success  mb-2">Completed</p>';
              } else {
                statusText = '<p class="badge badge-outline-danger mb-2">Ongoing</p>';
              }
              var progress = `
                <div class="progress">
                  <div class="progress-bar bg-primary progress-bar-animated progress-bar-striped" role="progressbar" style="width: ${emp.progress}%" aria-valuenow="${emp.progress}" aria-valuemin="0" aria-valuemax="100">
                    ${emp.progress}%
                  </div>
                </div>
              `;

              var daily_work = `
                <button class="btn btn-outline-info btn-sm rounded daily-work-btn" data-toggle="modal" data-target="#dworks" data-task-id="${emp.id}">Daily Works</button>
              `;

              var newRow = `
                <tr>
                  <td>${i + 1}</td>
                  <td>${emp.sdate}</td>
                  <td>${emp.edate}</td>
                  <td>${emp.name}</td>
                  <td>${emp.employee}</td>
                  <td>${progress}</td>
                  <td>${daily_work}</td>
                  <td>${statusText}</td>
                </tr>
              `;
              $('#ctable tbody').append(newRow);
            }
            

            // Event handler for the "Daily Works" button
            bindDailyWorkButtonClick('.daily-work-btn');
          }
        });
      } else {
        // If no option is selected, hide the tables
        $('#works').hide();
      }
    });

    // Event handler for the "Daily Works" button
    function bindDailyWorkButtonClick(selector) {
      $(document).off('click', selector).on('click', selector, function () {
        var taskId = $(this).data('task-id');
        // Perform AJAX request to get daily works for the task ID
        $.ajax({
          type: 'POST',  // Adjust the HTTP method as needed
          url: '{% url "admin_get_employee_dailyworkdetails" %}',
          data: {
            'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
            'task_id': taskId
          },
          success: function (data) {
            // Clear the table body
            $('#dtable tbody').empty();

            // Populate the table with the ongoing data
            for (var i = 0; i < data.details.length; i++) {
              var emp = data.details[i];
              var statusText = '';
              if (emp.status === 1) {
                statusText = '<p class="badge badge-outline-success  mb-2">Verified</p>';
              } else {
                statusText = '<p class="badge badge-outline-warning mb-2">Pending</p>';
              }

              var newRow = `
                <tr>
                  <td>${i + 1}</td>
                  <td>${emp.date}</td>
                  <td>${emp.title}</td>
                  <td>${emp.description}</td>
                  <td>${emp.target}</td>
                  <td>${emp.vtarget}</td> 
                  <td>${statusText}</td>
                </tr>
              `;
              $('#dtable tbody').append(newRow);
            }
          },
          error: function (error) {
            console.error('Error fetching daily works:', error);
          }
        });
      });
    }
  });
  </script>
  
  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- card show and hide section -->

<script>
  $(document).ready(function() {
  
    $('#rworks-btn').click(function() {
      $('#rworks').show();
      $('#ctasks').hide();
      $('#assignworks').hide();
      $('#ongoingwork').hide();
      $('#completedwork').hide();
    });

    $('#ctasks-btn').click(function() {
      $('#rworks').hide();
      $('#ctasks').show();
      $('#assignworks').hide();
      $('#ongoingwork').hide();
      $('#completedwork').hide();
      
    });

    $('#assignworks-btn').click(function() {
      $('#rworks').hide();
      $('#ctasks').hide();
      $('#assignworks').show();
      $('#ongoingwork').hide();
      $('#completedwork').hide();
    });

    $('#ongoing-btn').click(function() {
      $('#rworks').hide();
      $('#ctasks').hide();
      $('#assignworks').hide();
      $('#ongoingwork').show();
      $('#completedwork').hide();
    });

    $('#completed-btn').click(function() {
      $('#rworks').hide();
      $('#ctasks').hide();
      $('#assignworks').hide();
      $('#ongoingwork').hide();
      $('#completedwork').show();
    });

  });
</script>

<!-- date filter section -->

<script>
  // Add event listener for client date input changes
  $('#fdate1, #edate1').on('change', function () {
    filterTableByDate('rwtable', 'fdate1', 'edate1');
  });

  // Add event listener for client works date input changes
  $('#fdate2, #edate2').on('change', function () {
    filterTableByDate('cttable', 'fdate2', 'edate2');
  });

  // Add event listener for assigned works date input changes
  $('#fdate3, #edate3').on('change', function () {
    filterTableByDate('watable', 'fdate3', 'edate3');
  });

   // Add event listener for ongoing works date input changes
   $('#fdate4, #edate4').on('change', function () {
    filterTableByDate('otable', 'fdate4', 'edate4');
  });

  // Add event listener for completed works date input changes
  $('#fdate5, #edate5').on('change', function () {
    filterTableByDate('ctable', 'fdate5', 'edate5');
  });

  
  function filterTableByDate(tableId, fromDateId, toDateId) {
    var startDate = $('#' + fromDateId).val();
    var endDate = $('#' + toDateId).val();

    // Iterate through the specified table rows and hide/show them based on the date range
    $('#' + tableId + ' tbody tr').each(function () {
      var rowStartDate = $(this).find('td:eq(1)').text(); // Assuming start date is in the second column
      var rowEndDate = $(this).find('td:eq(1)').text(); // Assuming end date is in the third column

      if ((startDate === '' || rowStartDate >= startDate) && (endDate === '' || rowEndDate <= endDate)) {
        $(this).show();
      } else {
        $(this).hide();
      }
    });
  }
</script>



<!-- date input clear section -->

<script>

  function clearDateInputs() {
    document.getElementById("fdate1").value = "";
    document.getElementById("edate1").value = "";
    document.getElementById("fdate2").value = "";
    document.getElementById("edate2").value = "";
    document.getElementById("fdate3").value = "";
    document.getElementById("edate3").value = "";
    document.getElementById("fdate4").value = "";
    document.getElementById("edate4").value = "";
    document.getElementById("fdate5").value = "";
    document.getElementById("edate5").value = "";
  }
  
</script> 


{% endblock %}